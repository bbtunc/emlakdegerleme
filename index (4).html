<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EDMap</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #FAFAFA;
            color: #1A1A1A;
            font-weight: 400;
            overflow: hidden;
        }
        
        .header {
            background: white;
            padding: 14px 28px;
            display: flex;
            align-items: center;
            gap: 16px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
            border-bottom: 1px solid #E8E8E8;
            position: relative;
            z-index: 1000;
        }
        
        .logo {
            height: 38px;
            width: auto;
        }
        
        .header-text {
            flex: 1;
        }
        
        .header h1 {
            font-size: 1.25em;
            margin: 0;
            font-weight: 600;
            color: #00438C;
            letter-spacing: -0.02em;
        }

        .toggle-sidebar-btn {
            background: linear-gradient(135deg, #007973 0%, #1B9B97 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.2s;
            display: none;
        }

        .toggle-sidebar-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 121, 115, 0.3);
        }
        
        .container {
            display: flex;
            height: calc(100vh - 66px);
            position: relative;
        }
        
        .sidebar {
            width: 320px;
            background: white;
            border-right: 1px solid #E8E8E8;
            overflow-y: auto;
            padding: 16px;
            transition: transform 0.3s ease, margin-left 0.3s ease;
            position: relative;
            z-index: 999;
        }

        .sidebar.collapsed {
            transform: translateX(-100%);
            margin-left: -320px;
        }

        .sidebar-close-btn {
            display: none;
            position: absolute;
            top: 10px;
            right: 10px;
            background: #f5f5f5;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            color: #666;
        }

        .sidebar-close-btn:hover {
            background: #e0e0e0;
        }
        
        .sidebar h2 {
            color: #1A1A1A;
            font-size: 0.9em;
            margin-bottom: 12px;
            font-weight: 600;
            letter-spacing: -0.01em;
        }

        .section {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #E8E8E8;
        }

        .section:last-child {
            border-bottom: none;
        }
        
        .upload-section {
            margin-bottom: 16px;
        }
        
        .upload-area {
            border: 1.5px dashed #E8E8E8;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            background: #FAFAFA;
            cursor: pointer;
            transition: all 0.25s;
        }
        
        .upload-area:hover {
            border-color: #007973;
            background: white;
        }
        
        .upload-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }
        
        .upload-text {
            color: #666;
            font-size: 0.85em;
            line-height: 1.4;
        }
        
        #fileInput {
            display: none;
        }

        .map-style-selector {
            margin-bottom: 16px;
        }

        .map-style-selector select {
            width: 100%;
            padding: 10px;
            border: 1px solid #E8E8E8;
            border-radius: 6px;
            font-size: 0.9em;
            font-family: 'Inter', sans-serif;
            background: white;
            cursor: pointer;
        }

        .drawing-tools {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .draw-btn {
            flex: 1;
            min-width: 45%;
            padding: 10px;
            background: white;
            border: 1px solid #E8E8E8;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .draw-btn:hover {
            border-color: #007973;
            background: #f9f9f9;
        }

        .draw-btn.active {
            background: #007973;
            color: white;
            border-color: #007973;
        }
        
        .file-list {
            margin-top: 12px;
        }
        
        .file-list-header {
            font-size: 0.75em;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            margin-bottom: 8px;
        }
        
        .file-item {
            background: white;
            border: 1px solid #E8E8E8;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            transition: all 0.2s;
        }
        
        .file-item:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        
        .file-name {
            font-weight: 500;
            color: #1A1A1A;
            font-size: 0.85em;
            margin-bottom: 6px;
        }
        
        .file-uploader {
            font-size: 0.75em;
            color: #007973;
            margin-bottom: 8px;
        }
        
        .file-actions {
            display: flex;
            gap: 6px;
        }
        
        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
            transition: all 0.2s;
            font-weight: 500;
            font-family: 'Inter', sans-serif;
            flex: 1;
        }
        
        .btn-toggle {
            background: #007973;
            color: white;
        }
        
        .btn-toggle:hover {
            background: #005f5a;
        }
        
        .btn-toggle.hidden {
            background: #D0D0D0;
        }
        
        .btn-edit {
            background: #00ACE5;
            color: white;
        }
        
        .btn-edit:hover {
            background: #0090c4;
        }
        
        .btn-remove {
            background: #E53935;
            color: white;
        }
        
        .btn-remove:hover {
            background: #c62828;
        }

        .btn-share {
            background: #4CAF50;
            color: white;
        }

        .btn-share:hover {
            background: #388E3C;
        }

        .ai-chat-section {
            position: relative;
        }

        .ai-chat-toggle {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.2s;
        }

        .ai-chat-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .ai-chat-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 400px;
            max-width: calc(100vw - 40px);
            height: 500px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            display: none;
            flex-direction: column;
            z-index: 10000;
        }

        .ai-chat-container.active {
            display: flex;
        }

        .ai-chat-header {
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ai-chat-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
        }

        .ai-chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            background: #f9f9f9;
        }

        .ai-message {
            margin-bottom: 12px;
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 0.85em;
            line-height: 1.5;
        }

        .ai-message.user {
            background: #667eea;
            color: white;
            margin-left: 40px;
        }

        .ai-message.assistant {
            background: white;
            color: #333;
            margin-right: 40px;
            border: 1px solid #e0e0e0;
        }

        .ai-chat-input-container {
            padding: 16px;
            border-top: 1px solid #e0e0e0;
            background: white;
            border-radius: 0 0 12px 12px;
        }

        .ai-chat-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-family: 'Inter', sans-serif;
            font-size: 0.9em;
            resize: none;
        }

        .ai-send-btn {
            margin-top: 8px;
            width: 100%;
            padding: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

        .ai-send-btn:hover {
            opacity: 0.9;
        }
        
        #map {
            flex: 1;
            height: 100%;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9998;
        }

        .modal-overlay.active {
            display: block;
        }

        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 12px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            z-index: 9999;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        .modal.active {
            display: block;
        }

        .modal h2 {
            margin-bottom: 20px;
            color: #00438C;
        }

        .modal-input {
            width: 100%;
            padding: 10px;
            margin-bottom: 12px;
            border: 1px solid #E8E8E8;
            border-radius: 6px;
            font-family: 'Inter', sans-serif;
            font-size: 0.9em;
        }

        .modal-textarea {
            width: 100%;
            padding: 10px;
            margin-bottom: 12px;
            border: 1px solid #E8E8E8;
            border-radius: 6px;
            font-family: 'Inter', sans-serif;
            font-size: 0.9em;
            min-height: 100px;
            resize: vertical;
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-family: 'Inter', sans-serif;
            transition: all 0.2s;
        }

        .modal-btn-primary {
            background: #007973;
            color: white;
        }

        .modal-btn-primary:hover {
            background: #005f5a;
        }

        .modal-btn-secondary {
            background: #E8E8E8;
            color: #333;
        }

        .modal-btn-secondary:hover {
            background: #d0d0d0;
        }

        .popup-img {
            width: 100%;
            max-width: 300px;
            height: auto;
            margin: 10px 0;
            border-radius: 8px;
        }

        .btn-directions {
            display: inline-block;
            padding: 8px 16px;
            background: #4CAF50;
            color: white;
            border-radius: 6px;
            text-decoration: none;
            font-size: 0.85em;
            margin-top: 10px;
            transition: all 0.2s;
        }

        .btn-directions:hover {
            background: #388E3C;
        }

        .success-notice {
            background: #d4edda;
            border: 1px solid #28a745;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
            font-size: 0.85em;
            color: #155724;
        }

        .loading-indicator {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 0.9em;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .toggle-sidebar-btn {
                display: block;
            }

            .sidebar {
                position: fixed;
                left: 0;
                top: 66px;
                height: calc(100vh - 66px);
                z-index: 1001;
                box-shadow: 2px 0 8px rgba(0, 0, 0, 0.1);
            }

            .sidebar.collapsed {
                transform: translateX(-100%);
                margin-left: 0;
            }

            .sidebar-close-btn {
                display: block;
            }

            .ai-chat-container {
                width: calc(100vw - 40px);
                height: 400px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <img src="https://imar.istanbul/logo_ibb.png" alt="ƒ∞BB Logo" class="logo">
        <div class="header-text">
            <h1>EDMap</h1>
        </div>
        <button class="toggle-sidebar-btn" onclick="toggleSidebar()">‚ò∞ Men√º</button>
    </div>

    <div class="container">
        <div class="sidebar" id="sidebar">
            <button class="sidebar-close-btn" onclick="toggleSidebar()">‚úï</button>

            <!-- Success Notice -->
            <div class="success-notice" id="successNotice" style="display: none;">
                ‚úÖ Firebase baƒülantƒ±sƒ± ba≈üarƒ±lƒ±!
            </div>

            <!-- Map Style Selector -->
            <div class="section">
                <h2>üó∫Ô∏è Harita Stili</h2>
                <div class="map-style-selector">
                    <select id="mapStyleSelector" onchange="changeMapStyle()">
                        <option value="streets">Sokaklar</option>
                        <option value="satellite">Uydu</option>
                        <option value="hybrid">Hibrit</option>
                        <option value="terrain">Arazi</option>
                        <option value="topo">Topografik</option>
                        <option value="dark">Koyu Tema</option>
                        <option value="light">A√ßƒ±k Tema</option>
                        <option value="outdoors">A√ßƒ±k Hava</option>
                        <option value="transportation">Ula≈üƒ±m</option>
                        <option value="cycle">Bisiklet</option>
                        <option value="humanitarian">ƒ∞nsani</option>
                        <option value="night">Gece</option>
                        <option value="watercolor">Sulu Boya</option>
                        <option value="vintage">Vintage</option>
                        <option value="pencil">Karakalem</option>
                    </select>
                </div>
            </div>

            <!-- Drawing Tools -->
            <div class="section">
                <h2>‚úèÔ∏è √áizim Ara√ßlarƒ±</h2>
                <div class="drawing-tools">
                    <button class="draw-btn" onclick="startDrawing('marker')">üìç Pin Ekle</button>
                    <button class="draw-btn" onclick="startDrawing('polyline')">üìè √áizgi</button>
                    <button class="draw-btn" onclick="startDrawing('polygon')">‚¨° Alan</button>
                    <button class="draw-btn" onclick="startDrawing('rectangle')">‚ñ≠ Dikd√∂rtgen</button>
                    <button class="draw-btn" onclick="startDrawing('circle')">‚≠ï Daire</button>
                    <button class="draw-btn" onclick="clearDrawings()">üóëÔ∏è Temizle</button>
                </div>
            </div>

            <!-- File Upload -->
            <div class="section upload-section">
                <h2>üìÅ Dosya Y√ºkle</h2>
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">üì§</div>
                    <div class="upload-text">KML, KMZ, GeoJSON, DWG, DXF<br>S√ºr√ºkle ya da tƒ±kla</div>
                    <input type="file" id="fileInput" accept=".geojson,.json,.kml,.kmz,.dwg,.dxf" multiple>
                </div>
                <div class="file-list" id="fileList"></div>
            </div>

            <!-- Share Button -->
            <div class="section">
                <button class="btn btn-share" onclick="shareCurrentView()" style="width: 100%;">
                    üîó Payla≈ü
                </button>
            </div>

            <!-- AI Chat -->
            <div class="section ai-chat-section">
                <button class="ai-chat-toggle" onclick="toggleAIChat()">
                    ü§ñ AI Asistan ile Konu≈ü
                </button>
            </div>
        </div>

        <div id="map"></div>
    </div>

    <!-- AI Chat Container -->
    <div class="ai-chat-container" id="aiChatContainer">
        <div class="ai-chat-header">
            <h3>ü§ñ AI Asistan</h3>
            <button class="ai-chat-close" onclick="toggleAIChat()">‚úï</button>
        </div>
        <div class="ai-chat-messages" id="aiChatMessages">
            <div class="ai-message assistant">
                Merhaba! Harita ve parseller hakkƒ±nda sorularƒ±nƒ±zƒ± cevaplayabilirim. Size nasƒ±l yardƒ±mcƒ± olabilirim?
            </div>
        </div>
        <div class="ai-chat-input-container">
            <textarea class="ai-chat-input" id="aiChatInput" placeholder="Sorunuzu yazƒ±n..." rows="2"></textarea>
            <button class="ai-send-btn" onclick="sendAIMessage()">G√∂nder</button>
        </div>
    </div>

    <!-- Name Modal -->
    <div class="modal-overlay" id="nameModalOverlay"></div>
    <div class="modal" id="nameModal">
        <h2>Kullanƒ±cƒ± Bilgileri</h2>
        <input type="text" class="modal-input" id="userName" placeholder="Adƒ±nƒ±z *" required>
        <input type="text" class="modal-input" id="userSurname" placeholder="Soyadƒ±nƒ±z *" required>
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-primary" onclick="saveUserName()">Kaydet</button>
        </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal-overlay" id="editModalOverlay"></div>
    <div class="modal" id="editModal">
        <h2>Dosya D√ºzenle</h2>
        <input type="text" class="modal-input" id="editFileName" placeholder="Dosya Adƒ±" readonly>
        <input type="text" class="modal-input" id="editTitle" placeholder="Ba≈ülƒ±k">
        <textarea class="modal-textarea" id="editNotes" placeholder="Notlar"></textarea>
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-secondary" onclick="closeEditModal()">ƒ∞ptal</button>
            <button class="modal-btn modal-btn-primary" onclick="saveEdit()">Kaydet</button>
        </div>
    </div>

    <!-- Share Modal -->
    <div class="modal-overlay" id="shareModalOverlay"></div>
    <div class="modal" id="shareModal">
        <h2>Payla≈ü</h2>
        <p style="margin-bottom: 12px; font-size: 0.9em; color: #666;">
            Bu baƒülantƒ±yƒ± payla≈üarak y√ºklediƒüiniz dosyalarƒ± ba≈ükalarƒ±yla g√∂r√ºnt√ºleyebilirsiniz:
        </p>
        <input type="text" class="modal-input" id="shareLink" readonly>
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-secondary" onclick="closeShareModal()">Kapat</button>
            <button class="modal-btn modal-btn-primary" onclick="copyShareLink()">üìã Kopyala</button>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
    <script src="https://unpkg.com/leaflet-omnivore@0.3.4/leaflet-omnivore.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, doc, getDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyATdNx8dAy47w1gfKwmgfG07Nq9a67M3oc",
            authDomain: "bbtunc-fc77e.firebaseapp.com",
            projectId: "bbtunc-fc77e",
            storageBucket: "bbtunc-fc77e.firebasestorage.app",
            messagingSenderId: "720873591864",
            appId: "1:720873591864:web:360507d11bb560082402cd",
            measurementId: "G-WZC2SG4P4E"
        };

        let app, db, auth;
        let firebaseReady = false;

        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            signInAnonymously(auth).then(() => {
                firebaseReady = true;
                console.log('‚úÖ Firebase ba≈üarƒ±yla baƒülandƒ±!');
                document.getElementById('successNotice').style.display = 'block';
            }).catch(error => {
                console.error('‚ùå Firebase auth hatasƒ±:', error);
            });
        } catch (error) {
            console.error('‚ùå Firebase yapƒ±landƒ±rma hatasƒ±:', error);
        }

        window.db = db;
        window.firebaseReady = () => firebaseReady;
        window.uploadToFirebase = uploadToFirebase;
        window.loadFromFirebase = loadFromFirebase;
        window.askGeminiAI = askGeminiAI;

        async function uploadToFirebase(data) {
            if (!firebaseReady) {
                alert('Firebase baƒülantƒ±sƒ± kurulamadƒ±.');
                return null;
            }
            try {
                const docRef = await addDoc(collection(db, 'maps'), {
                    ...data,
                    createdAt: new Date().toISOString()
                });
                return docRef.id;
            } catch (error) {
                console.error('Firebase y√ºkleme hatasƒ±:', error);
                return null;
            }
        }

        async function loadFromFirebase(docId) {
            if (!firebaseReady) return null;
            try {
                const docRef = doc(db, 'maps', docId);
                const docSnap = await getDoc(docRef);
                return docSnap.exists() ? docSnap.data() : null;
            } catch (error) {
                console.error('Firebase okuma hatasƒ±:', error);
                return null;
            }
        }

async function askGeminiAI(question, context) {
    try {
        // Artƒ±k anahtar yok! Vercel'deki /api/gemini'ye istek atƒ±yoruz
        const response = await fetch('/api/gemini', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ question, context })
        });

        const data = await response.json();

        if (!response.ok || data.error) {
            console.error("Sunucu hatasƒ±:", data.error || "Bilinmeyen hata");
            return { error: true, message: 'AI cevap veremedi. L√ºtfen tekrar dene veya sayfayƒ± yenile.' };
        }

        // Ba≈üarƒ±lƒ± cevap
        return { error: false, message: data.message };
    } catch (error) {
        console.error("Baƒülantƒ± hatasƒ±:", error);
        return { error: true, message: 'ƒ∞nternet veya sunucu sorunu: ' + error.message };
    }
}
    </script>

    <script>
        let map;
        let currentUser = null;
        let loadedFiles = [];
        let currentEditingIndex = -1;
        let currentShareId = null;
        let drawnItems = new L.FeatureGroup();
        let drawControl;

        const mapStyles = {
            streets: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
            satellite: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
            hybrid: 'https://{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}',
            terrain: 'https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png',
            topo: 'https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png',
            dark: 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
            light: 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
            outdoors: 'https://tile.thunderforest.com/outdoors/{z}/{x}/{y}.png',
            transportation: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
            cycle: 'https://tile.thunderforest.com/cycle/{z}/{x}/{y}.png',
            humanitarian: 'https://tile.openstreetmap.fr/hot/{z}/{x}/{y}.png',
            night: 'https://map1.vis.earthdata.nasa.gov/wmts-webmerc/VIIRS_CityLights_2012/default//GoogleMapsCompatible_Level8/{z}/{y}/{x}.jpg',
            watercolor: 'https://stamen-tiles-{s}.a.ssl.fastly.net/watercolor/{z}/{x}/{y}.jpg',
            vintage: 'https://stamen-tiles-{s}.a.ssl.fastly.net/toner/{z}/{x}/{y}.png',
            pencil: 'https://stamen-tiles-{s}.a.ssl.fastly.net/toner-lite/{z}/{x}/{y}.png'
        };

        let currentLayer;

       window.onload = function() {
            initMap();
            checkUserName();
            loadShareIdFromURL();
            setupFileUpload();
            setupDrawingTools();

            // YENƒ∞ EKLENEN: data.kml dosyasƒ±nƒ± otomatik y√ºkle
            autoLoadGithubKML();
           // YENƒ∞ EKLENEN: KMZ dosyasƒ±nƒ± y√ºkler
            autoLoadGithubKMZ();
        
        };
// YENƒ∞ FONKSƒ∞YON: GitHub'daki KMZ dosyasƒ±nƒ± otomatik √ßeker, a√ßar ve i≈üler
async function autoLoadGithubKMZ() {
    // Dosya adƒ±nƒ± buraya tam olarak yaz (bo≈üluklara ve parantezlere dikkat)
    const fileName = 'Pym-Gayrimenkuller (1).kmz'; 
    const layerName = 'Pym Gayrimenkuller'; // Sol men√ºde g√∂r√ºnecek isim

    try {
        console.log(`üìÇ ${fileName} dosyasƒ± aranƒ±yor...`);
        
        // Dosyayƒ± fetch et
        const response = await fetch('./' + fileName);
        
        if (!response.ok) {
            console.warn(`‚ö†Ô∏è ${fileName} bulunamadƒ±. Dosya ismini ve konumunu kontrol edin.`);
            return;
        }

        // KMZ binary (ikili) bir dosya olduƒüu i√ßin 'blob' olarak alƒ±yoruz
        const blob = await response.blob();
        
        // JSZip k√ºt√ºphanesini kullanarak dosyayƒ± a√ßƒ±yoruz
        const zip = new JSZip();
        const contents = await zip.loadAsync(blob);
        
        // Zip i√ßindeki ilk .kml uzantƒ±lƒ± dosyayƒ± buluyoruz
        const kmlFileName = Object.keys(contents.files).find(name => name.endsWith('.kml'));
        
        if (!kmlFileName) {
            console.error("‚ùå KMZ dosyasƒ±nƒ±n i√ßinde ge√ßerli bir KML bulunamadƒ±.");
            return;
        }

        // KML i√ßeriƒüini metin (string) olarak okuyoruz
        const kmlText = await contents.files[kmlFileName].async('string');
        
        // omnivore ile parse edip haritaya ekliyoruz
        const layer = omnivore.kml.parse(kmlText);
        
        // Sisteme katman olarak ekle
        await processLayer(layerName, layer);
        
        console.log(`‚úÖ ${fileName} ba≈üarƒ±yla y√ºklendi ve haritaya eklendi.`);

    } catch (error) {
        console.error(`‚ùå ${fileName} otomatik y√ºklenirken hata olu≈ütu:`, error);
    }
}
        // YENƒ∞ FONKSƒ∞YON: GitHub'daki data.kml dosyasƒ±nƒ± √ßeker ve haritaya i≈üler
        async function autoLoadGithubKML() {
            const fileName = 'data.kml'; // Dosya adƒ± tam olarak bu olmalƒ±

            try {
                console.log("üìÇ GitHub'dan veri dosyasƒ± aranƒ±yor...");
                
                // Dosyayƒ± aynƒ± klas√∂rden √ßekmeye √ßalƒ±≈ü
                const response = await fetch('./' + fileName);
                
                if (!response.ok) {
                    console.warn("‚ö†Ô∏è data.kml dosyasƒ± bulunamadƒ±. Dosyanƒ±n index.html ile yan yana olduƒüundan emin olun.");
                    return;
                }

                const kmlText = await response.text();
                
                // KML'i harita formatƒ±na √ßevir (omnivore k√ºt√ºphanesi ile)
                const layer = omnivore.kml.parse(kmlText);
                
                // Senin sistemindeki processLayer fonksiyonunu kullanarak
                // hem haritaya hem de sol men√ºye ekle.
                // 'Ana Parsel Verisi' ismini istediƒüin gibi deƒüi≈ütirebilirsin.
                await processLayer('TAKASA KONU TA≈ûINMAZLAR', layer);
                
                console.log("‚úÖ data.kml ba≈üarƒ±yla y√ºklendi.");

            } catch (error) {
                console.error("‚ùå Otomatik y√ºkleme sƒ±rasƒ±nda hata olu≈ütu:", error);
            }
        }

        function initMap() {
            map = L.map('map').setView([41.0082, 28.9784], 11);
            
            currentLayer = L.tileLayer(mapStyles.streets, {
                maxZoom: 19,
                attribution: '¬© OpenStreetMap',
                subdomains: ['a', 'b', 'c']
            }).addTo(map);

            map.addLayer(drawnItems);
            map.zoomControl.setPosition('topright');
            
            L.control.scale({
                imperial: false,
                metric: true
            }).addTo(map);
        }

        function setupDrawingTools() {
            drawControl = new L.Control.Draw({
                position: 'topright',
                draw: {
                    polyline: false,
                    polygon: false,
                    circle: false,
                    rectangle: false,
                    marker: false,
                    circlemarker: false
                },
                edit: {
                    featureGroup: drawnItems,
                    remove: true
                }
            });
            map.addControl(drawControl);

            map.on(L.Draw.Event.CREATED, function (e) {
                const layer = e.layer;
                const note = prompt('Bu √ßizim i√ßin bir not ekleyin:');
                if (note) {
                    layer.bindPopup(`<strong>Not:</strong> ${note}<br><small>Ekleyen: ${currentUser}</small>`);
                }
                drawnItems.addLayer(layer);
                saveDrawingsToFirebase();
            });
        }

        function checkUserName() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = savedUser;
            } else {
                document.getElementById('nameModalOverlay').classList.add('active');
                document.getElementById('nameModal').classList.add('active');
            }
        }

        function saveUserName() {
            const name = document.getElementById('userName').value.trim();
            const surname = document.getElementById('userSurname').value.trim();
            
            if (!name || !surname) {
                alert('L√ºtfen ad ve soyad bilgilerinizi girin!');
                return;
            }
            
            currentUser = `${name} ${surname}`;
            localStorage.setItem('currentUser', currentUser);
            
            document.getElementById('nameModalOverlay').classList.remove('active');
            document.getElementById('nameModal').classList.remove('active');
        }

        function changeMapStyle() {
            const style = document.getElementById('mapStyleSelector').value;
            
            if (currentLayer) {
                map.removeLayer(currentLayer);
            }
            
            const subdomains = style === 'hybrid' ? ['mt0', 'mt1', 'mt2', 'mt3'] : ['a', 'b', 'c'];
            
            currentLayer = L.tileLayer(mapStyles[style], {
                maxZoom: 19,
                attribution: '¬© Map Data',
                subdomains: subdomains
            }).addTo(map);
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('collapsed');
        }

        function startDrawing(type) {
            const handlers = {
                marker: new L.Draw.Marker(map),
                polyline: new L.Draw.Polyline(map),
                polygon: new L.Draw.Polygon(map),
                rectangle: new L.Draw.Rectangle(map),
                circle: new L.Draw.Circle(map)
            };
            
            if (handlers[type]) {
                handlers[type].enable();
            }
        }

        function clearDrawings() {
            if (confirm('T√ºm √ßizimleri silmek istediƒüinizden emin misiniz?')) {
                drawnItems.clearLayers();
                saveDrawingsToFirebase();
            }
        }

        async function saveDrawingsToFirebase() {
            if (!window.firebaseReady()) return;
            
            const drawings = [];
            drawnItems.eachLayer(layer => {
                drawings.push(layer.toGeoJSON());
            });
            
            if (currentShareId) {
                const docRef = doc(window.db, 'maps', currentShareId);
                await updateDoc(docRef, { drawings });
            }
        }

        function setupFileUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            
            uploadArea.onclick = () => fileInput.click();
            
            uploadArea.ondragover = (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#007973';
            };
            
            uploadArea.ondragleave = () => {
                uploadArea.style.borderColor = '#E8E8E8';
            };
            
            uploadArea.ondrop = (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#E8E8E8';
                handleFiles(e.dataTransfer.files);
            };
            
            fileInput.onchange = (e) => {
                handleFiles(e.target.files);
            };
        }

        async function handleFiles(files) {
            if (!currentUser) {
                alert('L√ºtfen √∂nce adƒ±nƒ±zƒ± ve soyadƒ±nƒ±zƒ± girin!');
                checkUserName();
                return;
            }

            for (const file of files) {
                const ext = file.name.split('.').pop().toLowerCase();
                
                if (ext === 'kml') {
                    await handleKML(file);
                } else if (ext === 'kmz') {
                    await handleKMZ(file);
                } else if (ext === 'geojson' || ext === 'json') {
                    await handleGeoJSON(file);
                } else if (ext === 'dwg' || ext === 'dxf') {
                    alert('DWG/DXF formatlarƒ± i√ßin √∂zel d√∂n√º≈üt√ºr√ºc√º gerekli. L√ºtfen dosyayƒ± KML veya GeoJSON formatƒ±na d√∂n√º≈üt√ºr√ºn.');
                } else {
                    alert('Desteklenmeyen dosya formatƒ±: ' + ext);
                }
            }
        }

        async function handleKML(file) {
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const kmlText = e.target.result;
                    const layer = omnivore.kml.parse(kmlText);
                    
                    await processLayer(file.name, layer);
                } catch (error) {
                    console.error('KML okuma hatasƒ±:', error);
                    alert('KML dosyasƒ± okunamadƒ±: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        async function handleKMZ(file) {
            try {
                const zip = new JSZip();
                const contents = await zip.loadAsync(file);
                const kmlFile = Object.keys(contents.files).find(name => name.endsWith('.kml'));
                
                if (!kmlFile) {
                    alert('KMZ i√ßinde KML dosyasƒ± bulunamadƒ±!');
                    return;
                }
                
                const kmlText = await contents.files[kmlFile].async('string');
                const layer = omnivore.kml.parse(kmlText);
                
                await processLayer(file.name, layer);
            } catch (error) {
                console.error('KMZ okuma hatasƒ±:', error);
                alert('KMZ dosyasƒ± okunamadƒ±: ' + error.message);
            }
        }

        async function handleGeoJSON(file) {
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const geojson = JSON.parse(e.target.result);
                    const layer = L.geoJSON(geojson);
                    
                    await processLayer(file.name, layer);
                } catch (error) {
                    console.error('GeoJSON okuma hatasƒ±:', error);
                    alert('GeoJSON dosyasƒ± okunamadƒ±: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        async function processLayer(fileName, layer) {
            layer.eachLayer(subLayer => {
                if (subLayer.feature && subLayer.feature.properties) {
                    setupFeaturePopup(subLayer, subLayer.feature, fileName);
                }
            });

            const fileObj = {
                name: fileName,
                uploader: currentUser,
                layer: layer,
                visible: true,
                customTitle: '',
                customNotes: ''
            };

            loadedFiles.push(fileObj);
            map.addLayer(layer);
            updateFileList();

            if (window.firebaseReady()) {
                const geoJSON = layer.toGeoJSON();
                const shareId = await window.uploadToFirebase({
                    fileName: fileName,
                    uploader: currentUser,
                    geojson: geoJSON,
                    timestamp: new Date().toISOString()
                });
                
                if (shareId) {
                    currentShareId = shareId;
                }
            }
        }

        function setupFeaturePopup(layer, feature, fileName) {
            const props = feature.properties;
            const coords = layer.getLatLng ? layer.getLatLng() : layer.getBounds().getCenter();
            
            const updatePopup = () => {
                const fileIndex = loadedFiles.findIndex(f => f.name === fileName);
                const fileObj = loadedFiles[fileIndex];
                
                let content = '<div style="max-width: 300px;">';
                
                if (props.name) {
                    content += `<h3 style="color: #00438C; margin-bottom: 10px;">${props.name}</h3>`;
                }
                
                if (props.description) {
                    content += `<p>${props.description}</p>`;
                }
                
                if (fileObj && fileObj.customTitle) {
                    content += `<p><strong>${fileObj.customTitle}</strong></p>`;
                }
                
                if (fileObj && fileObj.customNotes) {
                    content += `<p style="font-size: 0.9em; color: #666;">${fileObj.customNotes}</p>`;
                }
                
                content += `
                    <a href="https://www.google.com/maps/dir/?api=1&destination=${coords.lat},${coords.lng}" 
                       target="_blank" class="btn-directions">üó∫Ô∏è Yol Tarifi</a>
                `;
                
                if (fileObj) {
                    content += `<p style="font-size: 0.8em; color: #007973; margin-top: 10px;">üë§ ${fileObj.uploader}</p>`;
                }
                
                content += '</div>';
                
                layer.bindPopup(content);
            };
            
            updatePopup();
            layer.on('click', updatePopup);
        }

        function updateFileList() {
            const fileList = document.getElementById('fileList');
            
            if (loadedFiles.length === 0) {
                fileList.innerHTML = '';
                return;
            }
            
            let html = '<div class="file-list-header">Y√ºklenen Dosyalar</div>';
            
            loadedFiles.forEach((fileObj, index) => {
                html += `
                    <div class="file-item">
                        <div class="file-name">${fileObj.name}</div>
                        <div class="file-uploader">üë§ ${fileObj.uploader}</div>
                        <div class="file-actions">
                            <button class="btn btn-toggle ${fileObj.visible ? '' : 'hidden'}" 
                                onclick="toggleFileVisibility(${index})">
                                ${fileObj.visible ? 'üëÅÔ∏è' : 'üîí'}
                            </button>
                            <button class="btn btn-edit" onclick="openEditModal(${index})">‚úèÔ∏è</button>
                            <button class="btn btn-remove" onclick="removeFile(${index})">‚úï</button>
                        </div>
                    </div>
                `;
            });
            
            fileList.innerHTML = html;
        }

        function toggleFileVisibility(index) {
            const fileObj = loadedFiles[index];
            fileObj.visible = !fileObj.visible;
            
            if (fileObj.visible) {
                map.addLayer(fileObj.layer);
            } else {
                map.removeLayer(fileObj.layer);
            }
            
            updateFileList();
        }

        function removeFile(index) {
            if (!confirm('Bu dosyayƒ± silmek istediƒüinizden emin misiniz?')) return;
            
            const fileObj = loadedFiles[index];
            map.removeLayer(fileObj.layer);
            loadedFiles.splice(index, 1);
            updateFileList();
        }

        function openEditModal(index) {
            currentEditingIndex = index;
            const fileObj = loadedFiles[index];
            
            document.getElementById('editFileName').value = fileObj.name;
            document.getElementById('editTitle').value = fileObj.customTitle || '';
            document.getElementById('editNotes').value = fileObj.customNotes || '';
            
            document.getElementById('editModalOverlay').classList.add('active');
            document.getElementById('editModal').classList.add('active');
        }

        function closeEditModal() {
            document.getElementById('editModalOverlay').classList.remove('active');
            document.getElementById('editModal').classList.remove('active');
            currentEditingIndex = -1;
        }

        function saveEdit() {
            if (currentEditingIndex === -1) return;
            
            const fileObj = loadedFiles[currentEditingIndex];
            fileObj.customTitle = document.getElementById('editTitle').value;
            fileObj.customNotes = document.getElementById('editNotes').value;
            
            closeEditModal();
        }

        async function shareCurrentView() {
            if (loadedFiles.length === 0 && drawnItems.getLayers().length === 0) {
                alert('Payla≈üƒ±lacak i√ßerik yok!');
                return;
            }

            if (window.firebaseReady()) {
                const shareData = {
                    files: loadedFiles.map(f => ({
                        name: f.name,
                        uploader: f.uploader,
                        geojson: f.layer.toGeoJSON(),
                        customTitle: f.customTitle,
                        customNotes: f.customNotes
                    })),
                    drawings: [],
                    createdBy: currentUser,
                    createdAt: new Date().toISOString()
                };

                drawnItems.eachLayer(layer => {
                    shareData.drawings.push(layer.toGeoJSON());
                });

                const shareId = await window.uploadToFirebase(shareData);
                
                if (shareId) {
                    const shareUrl = `${window.location.origin}${window.location.pathname}?share=${shareId}`;
                    document.getElementById('shareLink').value = shareUrl;
                    document.getElementById('shareModalOverlay').classList.add('active');
                    document.getElementById('shareModal').classList.add('active');
                }
            } else {
                alert('Firebase baƒülantƒ±sƒ± gerekli.');
            }
        }

        function closeShareModal() {
            document.getElementById('shareModalOverlay').classList.remove('active');
            document.getElementById('shareModal').classList.remove('active');
        }

        function copyShareLink() {
            const linkInput = document.getElementById('shareLink');
            linkInput.select();
            document.execCommand('copy');
            alert('Link kopyalandƒ±!');
        }

        async function loadShareIdFromURL() {
            const params = new URLSearchParams(window.location.search);
            const shareId = params.get('share');
            
            if (shareId && window.firebaseReady()) {
                setTimeout(async () => {
                    const data = await window.loadFromFirebase(shareId);
                    
                    if (data) {
                        currentShareId = shareId;
                        
                        if (data.files) {
                            for (const fileData of data.files) {
                                const layer = L.geoJSON(fileData.geojson);
                                
                                layer.eachLayer(subLayer => {
                                    if (subLayer.feature) {
                                        setupFeaturePopup(subLayer, subLayer.feature, fileData.name);
                                    }
                                });
                                
                                const fileObj = {
                                    name: fileData.name,
                                    uploader: fileData.uploader,
                                    layer: layer,
                                    visible: true,
                                    customTitle: fileData.customTitle || '',
                                    customNotes: fileData.customNotes || ''
                                };
                                
                                loadedFiles.push(fileObj);
                                map.addLayer(layer);
                            }
                        }
                        
                        if (data.drawings) {
                            data.drawings.forEach(drawing => {
                                const layer = L.geoJSON(drawing);
                                drawnItems.addLayer(layer);
                            });
                        }
                        
                        updateFileList();
                    }
                }, 1000);
            }
        }

        function toggleAIChat() {
            const container = document.getElementById('aiChatContainer');
            container.classList.toggle('active');
        }

        async function sendAIMessage() {
            const input = document.getElementById('aiChatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            addAIMessage(message, 'user');
            input.value = '';
            
            const context = {
                files: loadedFiles.map(f => ({
                    name: f.name,
                    uploader: f.uploader
                })),
                drawings: drawnItems.getLayers().length
            };
            
            const response = await window.askGeminiAI(message, context);
            
            addAIMessage(response.error ? '‚ö†Ô∏è ' + response.message : response.message, 'assistant');
        }

        function addAIMessage(text, sender) {
            const messagesContainer = document.getElementById('aiChatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `ai-message ${sender}`;
            messageDiv.textContent = text;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        document.addEventListener('DOMContentLoaded', () => {
            const aiInput = document.getElementById('aiChatInput');
            if (aiInput) {
                aiInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendAIMessage();
                    }
                });
            }
        });

        document.getElementById('editModalOverlay').onclick = closeEditModal;
        document.getElementById('shareModalOverlay').onclick = closeShareModal;
        document.getElementById('nameModalOverlay').onclick = (e) => {
            if (!currentUser) {
                alert('L√ºtfen adƒ±nƒ±zƒ± ve soyadƒ±nƒ±zƒ± girmeniz gerekiyor!');
            }
        };
    </script>
</body>
</html>
